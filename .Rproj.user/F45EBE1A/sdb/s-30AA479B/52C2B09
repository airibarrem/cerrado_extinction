{
    "contents" : "rm(list=ls())\nrequire(raster)\nrequire(snowfall)\n\nheaviside = function(x){stepfun(0,c(0,1))(x)}\n\nrcompose = function(x, bgx){\n  # read input raster, if x is filename\n  if (is.character(x)){x = raster(x)}\n  # projects input raster into background raster\n  if(!is.na(crs(x))){x = projectRaster(x,bgx,method='ngb')}\n  # remove NA values from input raster\n  x[is.na(x)]=0\n  # mask input raster using the background one\n  x = x + bgx\n  return(x)\n}\n\ncond.area = function(x, xcond, convert.ha=TRUE, px.val=F){\n  # Returns an approximate area of pixels in \"x\" that satisfy \"xcond\" condition.\n  # \"xcond\" must be a logical raster (px values either 0 or 1).\n  zone.count = 0\n  zone.res = zonal(x,xcond,fun=function(x, na.rm){ if(na.rm){length(na.omit(x))}\n                                                   else{length(x)}})\n  if(length(zone.res[,1]) > 1){zone.count = zone.res[[2,2]]}\n  px.a = mean(values(area(x)))\n  res = px.a*zone.count\n  if (convert.ha==TRUE){res = res*100}\n  if (px.val == T){\n    print(paste(\"Px count:\",zone.count))\n    res = zone.count}\n  return(res)\n}\n\n# Intersects x with y, and masks the result with bgx\nintersect.raster = function(x, y, bgx){\n  if(is.character(x)){x=rcompose(x,bgx)}\n  if(is.character(y)){y=rcompose(y,bgx)}\n  return(rcompose(x*y,bgx))}\n\n\n###\n\n\n# Getting the list of names of all sp.dist files to be included\nsp.files = dir('./Flora_Cerrado/')\n\n# Rasterizing the background shapefile Using first file of sp.dist. as template\nbgd = rasterize(shapefile('./biome/Cerrado.shp'),\n                raster(paste0('./Flora_Cerrado/',sp.files[1])))\n\n# preparing bgd to be used as addition mask (add to a raster to apply the mask)\nbgd = bgd/bgd\nbgd[bgd>0]=0\n\n\n# Land-use rasters\nLU.now = rcompose('./LU/uso_da_terra_culturas2safra.tif',bgd)\nLU.bau = rcompose('./LU/Brasil2050.tif',bgd)\n\n# native vegetation mask (according to classes in original land-use rasters)\nnat.now = (LU.now %in% c(6,7,8)) + bgd\nnat.bau = (LU.bau %in% c(6,7,8)) + bgd\n\n\n# Applying intersect.raster and cond.area to all sp.dist files\nsfInit(parallel = T, cpus = 3, type = 'SOCK')\n  sfExportAll()\n  sfLibrary(raster)\n  # sp. potential area maps today\n  pot.maps = sfLapply(paste0('./Flora_Cerrado/',sp.files),rcompose,bgd)\n  # sp. habitats today\n  hab.maps = sfLapply(paste0('./Flora_Cerrado/',sp.files),intersect.raster,nat.now,bgd)\n  #sp. habitats under future LUC\n  bau.maps = sfLapply(paste0('./Flora_Cerrado/',sp.files),intersect.raster,nat.bau,bgd)\n  # List of all the maps for today\n  maps.list = c(pot.maps,hab.maps,bau.maps)\n  # List of the areas (in ha) corresponding to the list of maps above\n  pot.areas = sfLapply(pot.maps,function(x){cond.area(nat.now,x)})\n  hab.areas = sfLapply(hab.maps,function(x){cond.area(nat.now,x)})\n  bau.areas = sfLapply(bau.maps,function(x){cond.area(nat.bau,x)})\nsfStop()\n\n# Computing area data.frames\nnow.df = data.frame(Sp=sub(\"_\",' ',sub('.asc','',sp.files)))\nnow.df$Pot_Area = as.numeric(pot.areas)\nnow.df$Hab_Area = as.numeric(hab.areas)\nnow.df$BAU_Area = as.numeric(bau.areas)\nnow.df = now.df[order(now.df$Sp),]\n\nteste.df = now.df\nteste.df[,3:4] = now.df[,3:4] / as.numeric(now.df[,2])\n\n\n# Outputting area data.frames\nwrite.csv(now.df, file='Flora_otimizagro')\nwrite.csv2(now.df, file='Flora_otimizagro_2')\n\nwrite.csv(teste.df, file='Flora_otimizagro_perc')\nwrite.csv2(teste.df, file='Flora_otimizagro_perc_2')\n",
    "created" : 1459303823269.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1108650753",
    "id" : "52C2B09",
    "lastKnownWriteTime" : 1459292348,
    "path" : "D:/cerrado_extinction/hab_britaldo_redux.R",
    "project_path" : "hab_britaldo_redux.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "type" : "r_source"
}